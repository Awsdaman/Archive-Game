<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>جولة الأرشيف | The Archive Round</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0e;--surface:#111117;--surface2:#18181f;--surface3:#1e1e27;
  --accent:#c8f135;--accent2:#a8d120;--accent-glow:rgba(200,241,53,0.18);
  --accent-dim:rgba(200,241,53,0.08);--text:#f2f2f2;--text-dim:#777;
  --red:#ff4455;--red-dim:rgba(255,68,85,0.15);--green-dim:rgba(200,241,53,0.15);
  --border:rgba(200,241,53,0.15);--border2:rgba(255,255,255,0.07);
  --blue: #4488ff; --blue-dim: rgba(68, 136, 255, 0.15);
}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body.ltr{direction:ltr;font-family:'Oswald','Cairo',sans-serif}
.view{display:none;min-height:100vh;animation:fadeIn .35s ease}
.view.active{display:flex;flex-direction:column}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:9999}

.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border2);flex-shrink:0}
.logo{font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;letter-spacing:3px;color:var(--accent);text-transform:uppercase}
.lang-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:5px 13px;border-radius:20px;cursor:pointer;font-family:inherit;font-size:12px;transition:.2s}
.lang-btn:hover{color:var(--accent);border-color:var(--accent)}

input,select{background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:10px 13px;color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:.2s;width:100%}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
input::placeholder{color:#3a3a3a}
select option{background:var(--surface2);color:var(--text)}
label{font-size:12px;color:var(--text-dim);display:block;margin-bottom:5px}
.field{display:flex;flex-direction:column;gap:5px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

.btn-primary{background:var(--accent);color:#0a0a0e;font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;border:none;border-radius:8px;padding:14px;cursor:pointer;transition:.2s;width:100%}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 6px 20px var(--accent-glow)}
.btn-secondary{background:transparent;color:var(--text-dim);border:1px solid var(--border2);border-radius:8px;padding:9px 18px;cursor:pointer;font-family:inherit;font-size:13px;transition:.2s}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,68,85,0.25);border-radius:6px;padding:5px 10px;cursor:pointer;font-size:11px;font-family:inherit;transition:.2s;white-space:nowrap}
.btn-danger:hover{background:rgba(255,68,85,0.25)}
.btn-cloud{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(68,136,255,0.25);border-radius:8px;padding:12px;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;transition:.2s;width:100%;text-align:center;}
.btn-cloud:hover{background:rgba(68,136,255,0.25);box-shadow:0 0 15px rgba(68,136,255,0.1)}

/* SETUP */
#view-setup{overflow-y:auto}
.setup-inner{max-width:560px;width:100%;margin:0 auto;padding:24px 20px 60px;display:flex;flex-direction:column;gap:14px}
.setup-hero{text-align:center;padding:16px 0 20px}
.setup-hero h1{font-family:'Oswald',sans-serif;font-size:clamp(2rem,7vw,3.2rem);font-weight:700;letter-spacing:3px;text-transform:uppercase;line-height:1}
.setup-hero h1 span{color:var(--accent)}
.setup-hero p{color:var(--text-dim);font-size:13px;margin-top:8px}
.sec-card{background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:18px;display:flex;flex-direction:column;gap:12px}
.sec-title{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:2px}
.sec-title.blue{color:var(--blue)}
.event-item{display:grid;grid-template-columns:38px 1fr 56px auto;gap:7px;align-items:center}
.ev-badge{font-family:'Oswald',sans-serif;font-weight:700;font-size:11px;padding:8px 0;border-radius:6px;text-align:center;cursor:pointer;user-select:none;transition:.15s}
.ev-badge.G{background:var(--green-dim);color:var(--accent);border:1px solid rgba(200,241,53,0.3)}
.ev-badge.A{background:rgba(100,150,255,0.12);color:#88aaff;border:1px solid rgba(100,150,255,0.25)}
.add-ev-btn{display:flex;align-items:center;justify-content:center;gap:6px;background:var(--surface3);border:1px dashed var(--border2);border-radius:8px;padding:9px;cursor:pointer;font-size:12px;color:var(--text-dim);transition:.2s;width:100%;font-family:inherit}
.add-ev-btn:hover{border-color:var(--accent);color:var(--accent)}
.target-preview{background:var(--surface2);border:1px solid var(--accent);border-radius:8px;padding:10px 14px;font-size:13px;color:var(--accent);min-height:38px;display:flex;align-items:center;word-break:break-word}

/* CLOUD LIST */
.cloud-list{display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto;padding-right:5px;}
.cloud-item{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border2);padding:10px 14px;border-radius:8px;transition:0.2s;}
.cloud-item:hover{border-color:var(--blue);}
.ci-info{display:flex;flex-direction:column;gap:3px;}
.ci-teams{font-size:14px;font-weight:700;}
.ci-meta{font-size:11px;color:var(--text-dim);}
.ci-load{background:var(--blue-dim);color:var(--blue);border:none;border-radius:6px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;transition:0.2s;}
.ci-load:hover{background:rgba(68,136,255,0.3);}

/* GAME */
#view-game{overflow:hidden}
.game-header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:12px 16px;gap:10px;border-bottom:1px solid var(--border2);flex-shrink:0}
.tsb{display:flex;flex-direction:column;gap:3px;padding:8px 12px;border-radius:10px;border:1px solid transparent;transition:0.3s}
.tsb.left{align-items:flex-end;text-align:right}
.tsb.right{align-items:flex-start;text-align:left}
body.ltr .tsb.left{align-items:flex-start;text-align:left}
body.ltr .tsb.right{align-items:flex-end;text-align:right}
.tsb.active-turn { background: var(--surface2); border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
.tsb.active-turn .tsb-name { color: var(--text); }
.tsb-name{font-size:11px;font-weight:700;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:0.3s}
.tsb-pts{font-family:'Oswald',sans-serif;font-size:30px;font-weight:700;color:var(--accent);line-height:1}
.tsb-strikes{display:flex;gap:4px}
.tsb.right .tsb-strikes{flex-direction:row-reverse}
body.ltr .tsb.right .tsb-strikes{flex-direction:row}
.sdot{width:9px;height:9px;border-radius:50%;background:var(--surface3);border:1px solid var(--border2);transition:.3s}
.sdot.hit{background:var(--red);border-color:var(--red);box-shadow:0 0 6px var(--red)}
.gcenter{display:flex;flex-direction:column;align-items:center;gap:2px}
.timer{font-family:'Oswald',sans-serif;font-size:26px;font-weight:700;min-width:52px;text-align:center;transition:color .3s}
.timer.warn{color:var(--red);animation:blink .5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.round-lbl{font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase}

.card-area{flex:1;overflow-y:auto;padding:12px}
.match-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;max-width:580px;margin:0 auto;box-shadow:0 0 40px rgba(200,241,53,0.05)}
.card-meta{display:grid;grid-template-columns:1fr 1fr}
.cmeta-cell{padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid var(--border2)}
.cmeta-cell:nth-child(2){border-right:1px solid var(--border2)}
body.ltr .cmeta-cell:nth-child(2){border-right:none;border-left:1px solid var(--border2)}
.cmeta-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);white-space:nowrap}
.card-teams{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:14px 12px;gap:8px;background:var(--surface2);border-bottom:1px solid var(--border)}
.cteam{display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center}
.cteam-name{font-size:13px;font-weight:700;line-height:1.2;word-break:break-word}
.cscore-wrap{display:flex;flex-direction:column;align-items:center;gap:3px}
.cscore-lbl{font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
.cscore-val{font-family:'Oswald',sans-serif;font-size:26px;font-weight:700;color:var(--accent)}
.card-target{padding:10px 14px;border-bottom:1px solid var(--border);background:rgba(200,241,53,0.03)}
.ctarget-lbl{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--accent);margin-bottom:5px}
.card-events{display:grid;grid-template-columns:1fr 1fr}
.cevents-col{padding:8px 0}
.cevents-col:nth-child(1){border-left:1px solid var(--border)}
body.ltr .cevents-col:nth-child(1){border-left:none;border-right:1px solid var(--border)}
.cevents-head{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);padding:0 10px 7px;text-align:center;border-bottom:1px solid var(--border2);margin-bottom:4px}

.sq{border-radius:7px;cursor:pointer;transition:.15s;user-select:none;display:flex;align-items:center;justify-content:center;font-family:'Oswald',sans-serif;font-weight:700;font-size:15px;color:var(--text-dim)}
.sq.hidden{background:var(--surface3);border:1px solid var(--border2)}
.sq.hidden:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);box-shadow:0 0 10px var(--accent-glow)}
.sq.hidden:active{transform:scale(.96)}
.sq.revealed{cursor:default;animation:flip .3s ease}
@keyframes flip{from{transform:scaleY(0);opacity:0}to{transform:scaleY(1);opacity:1}}
.sq-info{flex:1;min-height:34px;padding:5px 10px}
.sq-info.revealed{font-weight:700;font-size:13px}
.sq-team{min-height:64px;width:100%;padding:8px;flex-direction:column;gap:4px}
.sq-score{min-width:72px;min-height:48px}
.sq-target{width:100%;min-height:38px;padding:7px 12px;border-radius:8px;justify-content:flex-start}
.sq-target.hidden{border:1px solid rgba(200,241,53,0.2);justify-content:center}
.sq-target.hidden:hover{border-color:var(--accent)}
.sq-target.revealed{font-family:'Cairo',sans-serif;font-weight:700;font-size:14px;color:var(--accent)}
.sq-event{margin:3px 8px;padding:7px 10px;min-height:38px;gap:8px}
.ev-type{font-family:'Oswald',sans-serif;font-weight:700;font-size:11px;padding:2px 7px;border-radius:4px;white-space:nowrap}
.ev-type.G{background:var(--green-dim);color:var(--accent)}
.ev-type.A{background:rgba(100,150,255,0.12);color:#88aaff}
.ev-player{font-weight:700;font-size:12px;flex:1;font-family:'Cairo',sans-serif}
.ev-min{font-family:'Oswald',sans-serif;font-size:11px;color:var(--text-dim);white-space:nowrap}
.no-events{padding:10px;text-align:center;color:var(--text-dim);font-size:11px}

.controls{flex-shrink:0;border-top:1px solid var(--border2);padding:10px 14px;display:flex;flex-direction:column;gap:8px}
.ctrl-row{display:flex;gap:7px;align-items:center}
.ctrl-btn{flex:1;padding:9px 6px;border-radius:7px;border:none;cursor:pointer;font-family:'Oswald',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;transition:.2s}
.ctrl-btn:disabled{opacity:.25;cursor:not-allowed}
.btn-correct{background:var(--green-dim);color:var(--accent);border:1px solid rgba(200,241,53,0.25)}
.btn-correct:not(:disabled):hover{background:rgba(200,241,53,0.22)}
.btn-wrong{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,68,85,0.25)}
.btn-wrong:not(:disabled):hover{background:rgba(255,68,85,0.22)}
.btn-timer-ctrl{background:var(--surface2);color:var(--text);border:1px solid var(--border2)}
.btn-timer-ctrl:hover{border-color:var(--accent);color:var(--accent)}
.btn-revall{background:var(--surface2);color:var(--text-dim);border:1px solid var(--border2)}
.btn-revall:hover{color:var(--text)}
.status-bar{font-size:11px;color:var(--text-dim);text-align:center}
.status-bar.on{color:var(--accent);font-weight:700}
.team-ctrl-lbl{font-size:10px;color:var(--text-dim);text-align:center;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.team-btns{display:flex;gap:6px}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:center;justify-content:center}
.overlay.show{display:flex;animation:fadeIn .3s}
.overlay-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px 24px;max-width:360px;width:90%;text-align:center;display:flex;flex-direction:column;gap:14px}
.overlay-box h2{font-family:'Oswald',sans-serif;font-size:22px;font-weight:700;letter-spacing:2px}
.overlay-box h2 span{color:var(--accent)}
.overlay-box p{color:var(--text-dim);font-size:13px;line-height:1.5}
.score-disp{display:flex;justify-content:center;gap:20px;padding:8px 0}
.sd-item{display:flex;flex-direction:column;align-items:center;gap:2px}
.sd-name{font-size:11px;color:var(--text-dim)}
.sd-pts{font-family:'Oswald',sans-serif;font-size:36px;font-weight:700;color:var(--accent)}
.sd-sep{font-family:'Oswald',sans-serif;font-size:26px;color:var(--text-dim);align-self:center}
.overlay-btns{display:flex;gap:10px}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}
</style>
</head>
<body>

<div id="view-setup" class="view active">
  <div class="topbar">
    <span class="logo">⚽ Archive</span>
    <button class="lang-btn" onclick="toggleLang()">EN / AR</button>
  </div>
  <div class="setup-inner">
    <div class="setup-hero">
      <h1 id="hero-title">جولة <span>الأرشيف</span></h1>
      <p id="hero-sub">The Archive Round</p>
    </div>

    <div class="sec-card" style="border-color: rgba(68,136,255,0.3);">
      <div class="sec-title blue" id="sec-cloud">الأرشيف السحابي (المباريات المحفوظة)</div>
      <div class="cloud-list" id="cloud-matches-list">
        <div style="text-align:center; color:var(--text-dim); font-size:12px; padding:10px;">جاري الاتصال بقاعدة البيانات...</div>
      </div>
      <button class="btn-cloud" style="display:none;" id="btn-import-legacy" onclick="importLegacyMatches()">استيراد البطاقات الـ 10 السابقة ☁️</button>
    </div>

    <div class="sec-card">
      <div class="sec-title" id="sec-players">الفرق المتنافسة</div>
      <div class="row2">
        <div class="field"><label id="lbl-p1">اسم الفريق الأول</label><input id="inp-p1" type="text" placeholder="مثال: الهلال"></div>
        <div class="field"><label id="lbl-p2">اسم الفريق الثاني</label><input id="inp-p2" type="text" placeholder="مثال: النصر"></div>
      </div>
    </div>

    <div class="sec-card">
      <div class="sec-title" id="sec-match">معلومات المباراة</div>
      <div class="row2">
        <div class="field"><label id="lbl-home">الفريق المضيف</label><input id="inp-home" type="text" placeholder="مثال: الاتحاد" oninput="updateTargetPreview()"></div>
        <div class="field"><label id="lbl-away">الفريق الضيف</label><input id="inp-away" type="text" placeholder="مثال: الأهلي" oninput="updateTargetPreview()"></div>
      </div>
      <div class="row3">
        <div class="field"><label id="lbl-hscore">أهداف المضيف</label><input id="inp-hscore" type="number" min="0" max="20" value="0"></div>
        <div class="field"><label id="lbl-ascore">أهداف الضيف</label><input id="inp-ascore" type="number" min="0" max="20" value="0"></div>
        <div class="field"><label id="lbl-season">الموسم</label><input id="inp-season" type="text" placeholder="2024/2023"></div>
      </div>
      <div class="field"><label id="lbl-league">البطولة</label><input id="inp-league" type="text" placeholder="مثال: دوري روشن السعودي"></div>
    </div>

    <div class="sec-card">
      <div class="sec-title" id="sec-hev">أهداف وتمريرات المضيف</div>
      <div id="list-home" style="display:flex;flex-direction:column;gap:7px"></div>
      <button class="add-ev-btn" onclick="addEvent('home')">+ <span id="lbl-addhome">إضافة هدف / تمريرة</span></button>
    </div>

    <div class="sec-card">
      <div class="sec-title" id="sec-aev">أهداف وتمريرات الضيف</div>
      <div id="list-away" style="display:flex;flex-direction:column;gap:7px"></div>
      <button class="add-ev-btn" onclick="addEvent('away')">+ <span id="lbl-addaway">إضافة هدف / تمريرة</span></button>
    </div>

    <div class="sec-card">
      <div class="sec-title" id="sec-target">المطلوب</div>
      <div class="row2">
        <div class="field">
          <label id="lbl-ttype">نوع السؤال</label>
          <select id="inp-ttype" onchange="updateTargetPreview()">
            <option value="scored" id="opt-scored">من سجّل؟</option>
            <option value="assisted" id="opt-assisted">من صنع؟</option>
            <option value="custom" id="opt-custom">سؤال مخصص</option>
          </select>
        </div>
        <div class="field" id="fld-goalnum">
          <label id="lbl-tnum">رقم الهدف</label>
          <input id="inp-tnum" type="number" min="1" max="20" value="1" oninput="updateTargetPreview()">
        </div>
      </div>
      <div class="field" id="fld-tteam">
        <label id="lbl-tteam">لأي فريق؟</label>
        <select id="inp-tteam" onchange="updateTargetPreview()">
          <option value="home" id="opt-thome">المضيف</option>
          <option value="away" id="opt-taway">الضيف</option>
        </select>
      </div>
      <div class="field" id="fld-tcustom" style="display:none">
        <label id="lbl-tcustom">نص السؤال</label>
        <input id="inp-tcustom" type="text" placeholder="اكتب السؤال..." oninput="updateTargetPreview()">
      </div>
      <div class="field">
        <label id="lbl-tans">الإجابة الصحيحة (للمضيف فقط)</label>
        <input id="inp-tans" type="text" placeholder="اسم اللاعب">
      </div>
      <div class="target-preview" id="target-preview"></div>
    </div>
    
    <div style="display:flex; gap:10px;">
      <button class="btn-cloud" style="flex:1;" onclick="saveMatchToCloud()"><span id="lbl-save">حفظ في السحابة ☁️</span></button>
      <button class="btn-primary" style="flex:2;" onclick="startGame()"><span id="lbl-create">إنشاء البطاقة والبدء</span></button>
    </div>
  </div>
</div>

<div id="view-game" class="view">
  <div class="game-header">
    <div class="tsb left" id="tsb-p1">
      <div class="tsb-name" id="gh-p1">ف1</div>
      <div class="tsb-pts" id="gh-p1-pts">0</div>
      <div class="tsb-strikes" id="gh-p1-str"></div>
    </div>
    <div class="gcenter">
      <div class="round-lbl" id="lbl-round">الجولة</div>
      <div class="timer" id="timer">30</div>
    </div>
    <div class="tsb right" id="tsb-p2">
      <div class="tsb-name" id="gh-p2">ف2</div>
      <div class="tsb-pts" id="gh-p2-pts">0</div>
      <div class="tsb-strikes" id="gh-p2-str"></div>
    </div>
  </div>

  <div class="card-area">
    <div class="match-card" id="match-card"></div>
  </div>

  <div class="controls">
    <div class="status-bar" id="status-bar">—</div>
    <div class="ctrl-row">
      <button class="ctrl-btn btn-timer-ctrl" onclick="toggleTimer()">▶ <span id="lbl-tbtn">ابدأ</span></button>
      <button class="ctrl-btn btn-revall" onclick="revealAll()"><span id="lbl-revall">كشف الكل</span></button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <div class="team-ctrl-lbl" id="ctrl-p1-lbl">الفريق الأول</div>
        <div class="team-btns">
          <button class="ctrl-btn btn-correct" id="b-p1-ok" onclick="markAnswer(0,true)">✓ <span id="lbl-ok1">صح</span></button>
          <button class="ctrl-btn btn-wrong"   id="b-p1-no" onclick="markAnswer(0,false)">✗ <span id="lbl-no1">خطأ</span></button>
        </div>
      </div>
      <div>
        <div class="team-ctrl-lbl" id="ctrl-p2-lbl">الفريق الثاني</div>
        <div class="team-btns">
          <button class="ctrl-btn btn-correct" id="b-p2-ok" onclick="markAnswer(1,true)">✓ <span id="lbl-ok2">صح</span></button>
          <button class="ctrl-btn btn-wrong"   id="b-p2-no" onclick="markAnswer(1,false)">✗ <span id="lbl-no2">خطأ</span></button>
        </div>
      </div>
    </div>
    <div style="text-align:center">
      <button class="btn-secondary" style="font-size:12px;padding:7px 16px" onclick="goSetup()"><span id="lbl-edit">← العودة للأرشيف</span></button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="overlay-box">
    <h2 id="ro-title">نهاية الجولة</h2>
    <p id="ro-msg"></p>
    <div class="score-disp">
      <div class="sd-item"><div class="sd-name" id="ro-p1n">—</div><div class="sd-pts" id="ro-p1p">0</div></div>
      <div class="sd-sep">:</div>
      <div class="sd-item"><div class="sd-pts" id="ro-p2p">0</div><div class="sd-name" id="ro-p2n">—</div></div>
    </div>
    <div class="overlay-btns">
      <button class="btn-secondary" style="flex:1" onclick="closeOverlay();goSetup()"><span id="lbl-newcard">بطاقة جديدة</span></button>
      <button class="btn-primary" style="flex:1;padding:11px" onclick="closeOverlay();replayCard()"><span id="lbl-replay">نفس البطاقة</span></button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAT9pOeTdBrjlGIWWgKNnnJFJ1YkjdzowY",
    authDomain: "archive-game-ed2d4.firebaseapp.com",
    projectId: "archive-game-ed2d4",
    storageBucket: "archive-game-ed2d4.firebasestorage.app",
    messagingSenderId: "422396863360",
    appId: "1:422396863360:web:b490e9299b0da3bbcd1765"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
  window.fbCollection = collection;
  window.fbAddDoc = addDoc;
  window.fbGetDocs = getDocs;
  window.fbQuery = query;
  window.fbOrderBy = orderBy;
  window.fbServerTimestamp = serverTimestamp;

  window.fetchCloudMatches();
</script>

<script>
// ── TRANSLATIONS ──
const TX={
ar:{
  heroTitle:'جولة <span>الأرشيف</span>',heroSub:'The Archive Round',
  secCloud:'الأرشيف السحابي (المباريات المحفوظة)',
  secPlayers:'الفرق المتنافسة',secMatch:'معلومات المباراة',
  secHev:'أهداف وتمريرات المضيف',secAev:'أهداف وتمريرات الضيف',secTarget:'المطلوب',
  p1:'اسم الفريق الأول',p2:'اسم الفريق الثاني',
  home:'الفريق المضيف',away:'الفريق الضيف',
  hscore:'أهداف المضيف',ascore:'أهداف الضيف',season:'الموسم',league:'البطولة',
  addEv:'إضافة هدف / تمريرة',
  ttype:'نوع السؤال',tnum:'رقم الهدف',tteam:'لأي فريق؟',tcustom:'نص السؤال',tans:'الإجابة الصحيحة (للمضيف فقط)',
  optScored:'من سجّل؟',optAssisted:'من صنع؟',optCustom:'سؤال مخصص',
  optHome:'المضيف',optAway:'الضيف',
  create:'إنشاء البطاقة والبدء', save:'حفظ في السحابة ☁️',
  roundLbl:'الجولة',timerStart:'ابدأ',timerStop:'إيقاف',revall:'كشف الكل',
  ok:'صح',no:'خطأ',editCard:'← العودة للأرشيف',
  newCard:'بطاقة جديدة',replay:'نفس البطاقة',
  lblLeague:'البطولة',lblSeason:'الموسم',lblResult:'النتيجة',lblTarget:'المطلوب', lblAnswer: 'الإجابة',
  statusReady:'دور الفريق للعب...',statusTiming:'الوقت يعمل...',
  roTitle:'نهاية الجولة',roNobody:'لم يجب أحد بشكل صحيح',
  roCorrect:(n,p)=>`أجاب ${n} بشكل صحيح! (+${p} نقطة)`,
  noEvents:'—',lbl_G:'هدف',lbl_A:'تمريرة',
  tq_scored:(team,n)=>`من سجّل الهدف رقم ${n} لـ ${team}؟`,
  tq_assisted:(team,n)=>`من صنع الهدف رقم ${n} لـ ${team}؟`,
  errFill:'يرجى ملء أسماء الفرق والبطولة على الأقل',
  phPlayer:'اسم اللاعب',phMin:'د',phHome:'مثال: الاتحاد',phAway:'مثال: الأهلي',
  phLeague:'مثال: دوري روشن السعودي',phSeason:'2024/2023',phP1:'مثال: الهلال',phP2:'مثال: النصر',
  loadMatch:'تحميل',
},
en:{
  heroTitle:'The <span>Archive</span>',heroSub:'جولة الأرشيف',
  secCloud:'Cloud Archive (Saved Matches)',
  secPlayers:'Competing Teams',secMatch:'Match Info',
  secHev:'Home Goals & Assists',secAev:'Away Goals & Assists',secTarget:'Target Question',
  p1:'Team 1 Name',p2:'Team 2 Name',
  home:'Home Team',away:'Away Team',
  hscore:'Home Goals',ascore:'Away Goals',season:'Season',league:'League',
  addEv:'Add Goal / Assist',
  ttype:'Question Type',tnum:'Goal Number',tteam:'Which Team?',tcustom:'Question Text',tans:'Correct Answer (host only)',
  optScored:'Who scored?',optAssisted:'Who assisted?',optCustom:'Custom question',
  optHome:'Home',optAway:'Away',
  create:'Create Card & Start', save: 'Save to Cloud ☁️',
  roundLbl:'Round',timerStart:'Start',timerStop:'Stop',revall:'Reveal All',
  ok:'✓',no:'✗',editCard:'← Back to Archive',
  newCard:'New Card',replay:'Same Card',
  lblLeague:'League',lblSeason:'Season',lblResult:'Result',lblTarget:'Target', lblAnswer: 'Answer',
  statusReady:'Team turn...',statusTiming:'Timer running...',
  roTitle:'Round Over',roNobody:'Nobody answered correctly',
  roCorrect:(n,p)=>`${n} answered correctly! (+${p} pts)`,
  noEvents:'—',lbl_G:'G',lbl_A:'A',
  tq_scored:(team,n)=>`Who scored goal #${n} for ${team}?`,
  tq_assisted:(team,n)=>`Who assisted goal #${n} for ${team}?`,
  errFill:'Please fill in team names and league at minimum',
  phPlayer:'Player name',phMin:'min',phHome:'e.g. Al-Ittihad',phAway:'e.g. Al-Ahli',
  phLeague:'e.g. Saudi Pro League',phSeason:'2023/2024',phP1:'e.g. Al-Hilal',phP2:'e.g. Al-Nassr',
  loadMatch:'Load',
}};

let lang='ar';
let evCtr={home:0,away:0};
let G={};
let timerIv=null,timerSec=30,timerOn=false;
let loadedMatchesData = [];

const t=(k,...a)=>{const v=TX[lang][k];return typeof v==='function'?v(...a):v??k;};
const $=(id)=>document.getElementById(id);

// ── LANG ──
function toggleLang(){
  lang=lang==='ar'?'en':'ar';
  document.documentElement.lang=lang;
  document.documentElement.dir=lang==='ar'?'rtl':'ltr';
  document.body.classList.toggle('ltr',lang!=='ar');
  applyTX();updateTargetPreview(); renderCloudMatches();
}
function applyTX(){
  const s=(id,k)=>{const e=$(id);if(e)e.innerHTML=t(k);};
  const p=(id,k)=>{const e=$(id);if(e)e.placeholder=t(k);};
  s('hero-title','heroTitle');s('hero-sub','heroSub');
  s('sec-cloud','secCloud');s('sec-players','secPlayers');s('sec-match','secMatch');
  s('sec-hev','secHev');s('sec-aev','secAev');s('sec-target','secTarget');
  s('lbl-p1','p1');s('lbl-p2','p2');s('lbl-home','home');s('lbl-away','away');
  s('lbl-hscore','hscore');s('lbl-ascore','ascore');s('lbl-season','season');s('lbl-league','league');
  s('lbl-addhome','addEv');s('lbl-addaway','addEv');
  s('lbl-ttype','ttype');s('lbl-tnum','tnum');s('lbl-tteam','tteam');
  s('lbl-tcustom','tcustom');s('lbl-tans','tans');
  s('opt-scored','optScored');s('opt-assisted','optAssisted');s('opt-custom','optCustom');
  s('opt-thome','optHome');s('opt-taway','optAway');
  s('lbl-create','create'); s('lbl-save','save'); s('lbl-round','roundLbl');
  s('lbl-tbtn','timerStart');s('lbl-revall','revall');
  s('lbl-ok1','ok');s('lbl-no1','no');s('lbl-ok2','ok');s('lbl-no2','no');
  s('lbl-edit','editCard');s('lbl-newcard','newCard');s('lbl-replay','replay');
  p('inp-home','phHome');p('inp-away','phAway');p('inp-league','phLeague');
  p('inp-season','phSeason');p('inp-p1','phP1');p('inp-p2','phP2');
}

// ── CLOUD FUNCTIONS (FIREBASE) ──
async function fetchCloudMatches() {
  try {
    const q = window.fbQuery(window.fbCollection(window.db, "matches"), window.fbOrderBy("timestamp", "desc"));
    const querySnapshot = await window.fbGetDocs(q);
    loadedMatchesData = [];
    querySnapshot.forEach((doc) => {
      loadedMatchesData.push({ id: doc.id, ...doc.data() });
    });
    
    if(loadedMatchesData.length === 0) {
      $('btn-import-legacy').style.display = 'block'; 
    } else {
      $('btn-import-legacy').style.display = 'none';
    }
    renderCloudMatches();
  } catch(err) {
    console.error("Error fetching matches: ", err);
    $('cloud-matches-list').innerHTML = `<div style="text-align:center; color:var(--red); font-size:12px;">Failed to connect to database.</div>`;
  }
}

function renderCloudMatches() {
  const list = $('cloud-matches-list');
  if(loadedMatchesData.length === 0) {
    list.innerHTML = `<div style="text-align:center; color:var(--text-dim); font-size:12px;">لا توجد مباريات محفوظة بعد.</div>`;
    return;
  }
  
  list.innerHTML = loadedMatchesData.map((m, i) => `
    <div class="cloud-item">
      <div class="ci-info">
        <div class="ci-teams">${m.home} (${m.hscore}) - (${m.ascore}) ${m.away}</div>
        <div class="ci-meta">${m.league} | ${m.season}</div>
      </div>
      <button class="ci-load" onclick="loadMatchData(${i})">${t('loadMatch')}</button>
    </div>
  `).join('');
}

async function saveMatchToCloud() {
  const home = $('inp-home').value.trim();
  const away = $('inp-away').value.trim();
  const league = $('inp-league').value.trim();
  if(!home || !away || !league) { alert(t('errFill')); return; }

  const matchData = {
    home, away, league,
    season: $('inp-season').value.trim(),
    hscore: parseInt($('inp-hscore').value) || 0,
    ascore: parseInt($('inp-ascore').value) || 0,
    homeEvents: getEvents('home'),
    awayEvents: getEvents('away'),
    ttype: $('inp-ttype').value,
    tnum: $('inp-tnum').value,
    tteam: $('inp-tteam').value,
    tcustom: $('inp-tcustom').value.trim(),
    tans: $('inp-tans').value.trim(),
    timestamp: window.fbServerTimestamp()
  };

  try {
    await window.fbAddDoc(window.fbCollection(window.db, "matches"), matchData);
    alert(lang==='ar'?'تم الحفظ في السحابة بنجاح!':'Saved to cloud successfully!');
    fetchCloudMatches();
  } catch(err) {
    console.error("Error saving: ", err);
    alert("Error saving to cloud.");
  }
}

function loadMatchData(index) {
  const data = loadedMatchesData[index];
  
  $('inp-home').value = data.home || '';
  $('inp-away').value = data.away || '';
  $('inp-league').value = data.league || '';
  $('inp-season').value = data.season || '';
  $('inp-hscore').value = data.hscore || 0;
  $('inp-ascore').value = data.ascore || 0;

  $('list-home').innerHTML = ''; evCtr.home = 0;
  $('list-away').innerHTML = ''; evCtr.away = 0;

  if(data.homeEvents) {
    data.homeEvents.forEach(e => {
      addEvent('home');
      const id = evCtr.home;
      $(`ep-home-${id}`).value = e.player;
      $(`em-home-${id}`).value = e.minute && e.minute !== '-' ? e.minute : '';
      if (e.type === 'A') toggleType('home', id);
    });
  }
  
  if(data.awayEvents) {
    data.awayEvents.forEach(e => {
      addEvent('away');
      const id = evCtr.away;
      $(`ep-away-${id}`).value = e.player;
      $(`em-away-${id}`).value = e.minute && e.minute !== '-' ? e.minute : '';
      if (e.type === 'A') toggleType('away', id);
    });
  }

  if (data.ttype) {
    $('inp-ttype').value = data.ttype;
    $('inp-tnum').value = data.tnum || 1;
    $('inp-tteam').value = data.tteam || 'home';
    $('inp-tcustom').value = data.tcustom || '';
    $('inp-tans').value = data.tans || '';
  } else if (data.targetId) {
    $('inp-ttype').value = 'custom';
    $('inp-tcustom').value = 'الهدف المطلوب (مستورد من النسخة القديمة)';
    $('inp-tans').value = 'اللاعب المستهدف (تم التحديد شفهياً)';
  }

  updateTargetPreview();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function importLegacyMatches() {
  const legacyData = [{"id":1772083893938,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"مانشستر سيتي","away":"ريال مدريد","league":"دوري أبطال اوروبا","season":"2021/2022","hscore":"4","ascore":"3","homeEvents":[{"gid":2,"type":"G","player":"كيفين دي بروين","minute":"2","side":"home"},{"gid":3,"type":"A","player":"رياض محرز","minute":"-","side":"home"},{"gid":4,"type":"G","player":"جابرييل جيسوس","minute":"11","side":"home"},{"gid":6,"type":"A","player":"كيفين دي بروين","minute":"-","side":"home"},{"gid":7,"type":"G","player":"فيل فودين","minute":"53","side":"home"},{"gid":14,"type":"A","player":"فيرناندينيو","minute":"-","side":"home"},{"gid":18,"type":"G","player":"بيرناردو سيلفا","minute":"74","side":"home"},{"gid":19,"type":"A","player":"زينتشينكو","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"كريم بنزيما","minute":"33","side":"away"},{"gid":11,"type":"A","player":"فيرلان ميندي","minute":"-","side":"away"},{"gid":15,"type":"G","player":"فينيسيوس جونيور","minute":"55","side":"away"},{"gid":16,"type":"A","player":"فيرلان ميندي","minute":"-","side":"away"},{"gid":17,"type":"G","player":"كريم بنزيما","minute":"82","side":"away"}],"evNextId":20,"targetId":17},{"id":1772083448789,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"الارجنتين","away":"انجلترا","league":"كأس العالم","season":"1986","hscore":"2","ascore":"1","homeEvents":[{"gid":2,"type":"G","player":"دييغو مارادونا","minute":"51","side":"home"},{"gid":18,"type":"G","player":"دييغو مارادونا","minute":"55","side":"home"},{"gid":19,"type":"A","player":"هيكتور انريكي","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"غاري لينيكير","minute":"81","side":"away"},{"gid":11,"type":"A","player":"جون بارنز","minute":"-","side":"away"}],"evNextId":20,"targetId":9},{"id":1772083428968,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"ايطاليا","away":"فرنسا","league":"كأس العالم","season":"2006","hscore":"1","ascore":"1","homeEvents":[{"gid":2,"type":"G","player":"ماركو ماتيراتزي","minute":"19","side":"home"},{"gid":18,"type":"A","player":"اندريه بيرلو","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"زين الدين زيدان","minute":"7","side":"away"}],"evNextId":20,"targetId":18},{"id":1772082828076,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"السعودية","away":"كوريا الجنوبية","league":"كأس اسيا","season":"2023","hscore":"1","ascore":"1","homeEvents":[{"gid":2,"type":"G","player":"عبدالله رديف","minute":"46","side":"home"},{"gid":18,"type":"A","player":"سالم الدوسري","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"تشو كيو سونغ","minute":"90+9","side":"away"},{"gid":11,"type":"A","player":"سيول وونغ يو","minute":"-","side":"away"}],"evNextId":19,"targetId":2},{"id":1772082643708,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"السعودية","away":"اليابان","league":"تصفيات اسيا لكأس العالم","season":"2021","hscore":"1","ascore":"0","homeEvents":[{"gid":2,"type":"G","player":"فراس البريكان","minute":"72","side":"home"}],"awayEvents":[],"evNextId":21,"targetId":2},{"id":1772081884524,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"الهلال","away":"الاتحاد","league":"الدوري السعودي الممتاز","season":"2024/2025","hscore":"1","ascore":"4","homeEvents":[{"gid":2,"type":"G","player":"ماركوس ليوناردو","minute":"23","side":"home"},{"gid":3,"type":"A","player":"جواو كانسيلو","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"حسن كادش","minute":"29","side":"away"},{"gid":11,"type":"A","player":"موسى ديابي","minute":"-","side":"away"},{"gid":15,"type":"G","player":"ستيفين بيرجوين","minute":"45","side":"away"},{"gid":17,"type":"G","player":"ستيفين بيرجوين","minute":"51","side":"away"},{"gid":18,"type":"A","player":"نغولو كانتي","minute":"-","side":"away"},{"gid":19,"type":"G","player":"كريم بنزيما","minute":"86","side":"away"},{"gid":20,"type":"A","player":"موسى ديابي","minute":"-","side":"away"}],"evNextId":21,"targetId":19},{"id":1772081485156,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"الهلال","away":"الاتحاد","league":"الدوري السعودي الممتاز","season":"2023/2024","hscore":"4","ascore":"3","homeEvents":[{"gid":2,"type":"G","player":"اليكساندر ميتروفيتش","minute":"20","side":"home"},{"gid":3,"type":"A","player":"سعود عبدالحميد","minute":"-","side":"home"},{"gid":4,"type":"G","player":"اليكساندر ميتروفيتش","minute":"60","side":"home"},{"gid":6,"type":"G","player":"اليكساندر ميتروفيتش","minute":"65","side":"home"},{"gid":7,"type":"G","player":"سالم الدوسري","minute":"71","side":"home"},{"gid":14,"type":"A","player":"سيرجي سافيتش","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"رومارينهو","minute":"16","side":"away"},{"gid":11,"type":"A","player":"عبدالرزاق حمدلله","minute":"-","side":"away"},{"gid":15,"type":"G","player":"كريم بنزيما","minute":"38","side":"away"},{"gid":16,"type":"A","player":"أحمد بامسعود","minute":"-","side":"away"},{"gid":17,"type":"G","player":"عبدالرزاق حمدلله","minute":"45+8","side":"away"}],"evNextId":18,"targetId":17},{"id":1772080620588,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"مانشستر سيتي","away":"كيو بي ار","league":"الدوري الانجليزي الممتاز","season":"2011/2012","hscore":"3","ascore":"2","homeEvents":[{"gid":2,"type":"G","player":"بابلو زاباليتا","minute":"39","side":"home"},{"gid":3,"type":"A","player":"يايا توريه","minute":"-","side":"home"},{"gid":4,"type":"G","player":"ايدن دزيكو","minute":"90+1","side":"home"},{"gid":5,"type":"A","player":"دافيد سيلفا","minute":"-","side":"home"},{"gid":6,"type":"G","player":"سيرجيو اجويرو","minute":"90+3","side":"home"},{"gid":7,"type":"G","player":"ماريو بالوتيلي","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"دجيبريل سيسي","minute":"48","side":"away"},{"gid":11,"type":"G","player":"جايمي ماكي","minute":"66","side":"away"},{"gid":12,"type":"A","player":"ارماند تراوري","minute":"-","side":"away"}],"evNextId":14,"targetId":9},{"id":1772080149328,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"مانشستر يونايتد","away":"بايرن ميونيخ","league":"دوري أبطال أوروبا","season":"1998/1999","hscore":"2","ascore":"1","homeEvents":[{"gid":2,"type":"G","player":"تيدي شيرينجهام","minute":"90","side":"home"},{"gid":3,"type":"A","player":"ريان قيقز","minute":"-","side":"home"},{"gid":4,"type":"G","player":"اولي قانا سولشاير","minute":"92","side":"home"},{"gid":14,"type":"A","player":"تيدي شيرينجهام","minute":"","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"ماريو باسلر","minute":"6","side":"away"}],"evNextId":15,"targetId":4},{"id":1772079714896,"savedAt":"٢٦‏/٢‏/٢٠٢٦","p1":"اا","p2":"اا","home":"اي سي ميلان","away":"ليفربول","league":"دوري أبطال أوروبا","season":"2004/2005","hscore":"3","ascore":"3","homeEvents":[{"gid":2,"type":"G","player":"باولو مالديني","minute":"1","side":"home"},{"gid":3,"type":"A","player":"اندريه بيرلو","minute":"-","side":"home"},{"gid":4,"type":"G","player":"هيرنان كريسبو","minute":"39","side":"home"},{"gid":5,"type":"A","player":"شيفشينكو","minute":"-","side":"home"},{"gid":6,"type":"G","player":"هيرنان كريسبو","minute":"43","side":"home"},{"gid":7,"type":"G","player":"كاكا","minute":"-","side":"home"}],"awayEvents":[{"gid":9,"type":"G","player":"ستيفين جيرارد","minute":"54","side":"away"},{"gid":10,"type":"A","player":"جون ارن رايز","minute":"-","side":"away"},{"gid":11,"type":"G","player":"فلاديمير سمايسر","minute":"56","side":"away"},{"gid":12,"type":"A","player":"دييتمير هامان","minute":"-","side":"away"},{"gid":13,"type":"G","player":"تشابي الونسو","minute":"60","side":"away"}],"evNextId":14,"targetId":13}];

  $('btn-import-legacy').textContent = 'جاري الرفع... (Uploading...)';
  $('btn-import-legacy').disabled = true;

  try {
    for (const data of legacyData) {
      const matchData = {
        home: data.home || '',
        away: data.away || '',
        league: data.league || '',
        season: data.season || '',
        hscore: parseInt(data.hscore) || 0,
        ascore: parseInt(data.ascore) || 0,
        homeEvents: (data.homeEvents || []).map(e => ({ type: e.type, player: e.player, minute: e.minute })),
        awayEvents: (data.awayEvents || []).map(e => ({ type: e.type, player: e.player, minute: e.minute })),
        ttype: 'custom',
        tcustom: 'الهدف المطلوب (مستورد من النسخة القديمة)',
        tans: 'اللاعب المستهدف (تم التحديد شفهياً)',
        timestamp: window.fbServerTimestamp()
      };
      await window.fbAddDoc(window.fbCollection(window.db, "matches"), matchData);
    }
    alert(lang==='ar'?'تم استيراد المباريات الـ 10 بنجاح!':'Successfully imported 10 matches!');
    $('btn-import-legacy').style.display = 'none';
    fetchCloudMatches();
  } catch(err) {
    console.error("Error importing: ", err);
    alert("Error importing matches.");
    $('btn-import-legacy').textContent = 'استيراد البطاقات الـ 10 السابقة ☁️';
    $('btn-import-legacy').disabled = false;
  }
}

// ── EVENTS BUILDER ──
function addEvent(side){
  const id=++evCtr[side];
  const div=document.createElement('div');
  div.className='event-item';div.id=`ev-${side}-${id}`;
  div.innerHTML=`
    <div class="ev-badge G" id="eb-${side}-${id}" onclick="toggleType('${side}',${id})">G</div>
    <input type="text" placeholder="${t('phPlayer')}" id="ep-${side}-${id}" style="padding:8px 10px;font-size:13px">
    <input type="text" placeholder="${t('phMin')}" id="em-${side}-${id}" style="padding:8px 6px;font-size:13px;text-align:center">
    <button class="btn-danger" onclick="rmEvent('${side}',${id})">✕</button>`;
  $(`list-${side}`).appendChild(div);
}
function toggleType(side,id){
  const b=$(`eb-${side}-${id}`);
  const isG=b.classList.contains('G');
  b.classList.toggle('G',!isG);b.classList.toggle('A',isG);
  b.textContent=isG?'A':'G';
}
function rmEvent(side,id){ const e=$(`ev-${side}-${id}`);if(e)e.remove(); }
function getEvents(side){
  return [...$(`list-${side}`).querySelectorAll('.event-item')]
    .map(el=>{
      const parts=el.id.split('-');const s=parts[1],i=parts[2];
      const b=$(`eb-${s}-${i}`);
      const player=$(`ep-${s}-${i}`).value.trim();
      const min=$(`em-${s}-${i}`).value.trim();
      if(!player)return null;
      return{type:b.classList.contains('G')?'G':'A',player,minute:min};
    }).filter(Boolean);
}

// ── TARGET PREVIEW ──
function updateTargetPreview(){
  const ttype=$('inp-ttype').value;
  const isCustom=ttype==='custom';
  $('fld-tteam').style.display=isCustom?'none':'';
  $('fld-goalnum').style.display=isCustom?'none':'';
  $('fld-tcustom').style.display=isCustom?'':'none';
  let prev='';
  if(isCustom){prev=$('inp-tcustom').value||'...';}
  else{
    const n=$('inp-tnum').value||1;
    const ts=$('inp-tteam').value;
    const tn=ts==='home'?($('inp-home').value||t('optHome')):($('inp-away').value||t('optAway'));
    prev=ttype==='scored'?t('tq_scored',tn,n):t('tq_assisted',tn,n);
  }
  $('target-preview').textContent=prev;
}

// ── START GAME ──
function startGame(){
  const p1=$('inp-p1').value.trim(),p2=$('inp-p2').value.trim();
  const home=$('inp-home').value.trim(),away=$('inp-away').value.trim();
  const league=$('inp-league').value.trim();
  if(!p1||!p2||!home||!away||!league){alert(t('errFill'));return;}

  const hs=parseInt($('inp-hscore').value)||0,as=parseInt($('inp-ascore').value)||0;
  const season=$('inp-season').value.trim();
  const homeEvents=getEvents('home'),awayEvents=getEvents('away');

  const ttype=$('inp-ttype').value;
  let tq='';
  if(ttype==='custom'){tq=$('inp-tcustom').value.trim()||'?';}
  else{
    const n=$('inp-tnum').value||1;
    const ts=$('inp-tteam').value;
    const tn=ts==='home'?home:away;
    tq=ttype==='scored'?t('tq_scored',tn,n):t('tq_assisted',tn,n);
  }
  const tans=$('inp-tans').value.trim()||'؟';

  G={p1,p2,home,away,score:`${hs} - ${as}`,season,league,homeEvents,awayEvents,
     targetQ:tq,targetAnswer:tans,squares:[],revealed:new Set(),
     pts:[0,0],strikes:[0,0],eliminated:[false,false],roundActive:true, currentTurn: 0};

  buildSquares();
  renderGameHeader();
  renderCard();
  resetTimer();
  updateTurnUI();
  updateCtrlBtns();
  $('status-bar').textContent=t('statusReady');
  $('status-bar').className='status-bar';
  $('overlay').classList.remove('show');
  goTo('game');
}

// ── SQUARES ──
function buildSquares(){
  const sq=[];let n=0;
  const mk=(type,value,meta={})=>sq.push({id:++n,type,value,meta});
  mk('league',G.league);mk('season',G.season||'—');
  mk('team-home',G.home);mk('team-away',G.away);mk('score',G.score);
  mk('target',G.targetQ); mk('answer',G.targetAnswer);
  G.homeEvents.forEach(e=>mk('event-home',e.player,{type:e.type,minute:e.minute}));
  G.awayEvents.forEach(e=>mk('event-away',e.player,{type:e.type,minute:e.minute}));
  G.squares=sq;G.revealed=new Set();
}

// ── RENDER CARD ──
const isRev=id=>G.revealed.has(id);

function rInfo(sq){
  return isRev(sq.id)?`<span class="sq revealed sq-info">${sq.value}</span>`:`<span class="sq hidden sq-info" onclick="revSq(${sq.id})">${sq.id}</span>`;
}
function rTeam(sq,name){
  return isRev(sq.id)?`<div class="sq revealed sq-team cteam"><div class="cteam-name">${name}</div></div>`:`<div class="sq hidden sq-team" onclick="revSq(${sq.id})">${sq.id}</div>`;
}
function rScore(sq){
  return isRev(sq.id)?`<div class="sq revealed sq-score cscore-wrap"><div class="cscore-lbl">${t('lblResult')}</div><div class="cscore-val">${sq.value}</div></div>`:`<div class="sq hidden sq-score" onclick="revSq(${sq.id})">${sq.id}</div>`;
}
function rTarget(sq){
  return isRev(sq.id)?`<div class="sq revealed sq-target">${sq.value}</div>`:`<div class="sq hidden sq-target" onclick="revSq(${sq.id})">${sq.id}</div>`;
}
function rAnswer(sq){
  return isRev(sq.id)?`<div class="sq revealed sq-target" style="justify-content:center; color:#c8f135; text-align:center;">${sq.value}</div>`:`<div class="sq hidden sq-target" onclick="revSq(${sq.id})" style="justify-content:center;">${sq.id}</div>`;
}
function rEvent(sq){
  return isRev(sq.id)
    ?`<div class="sq revealed sq-event">
        <span class="ev-type ${sq.meta.type}">${t('lbl_'+sq.meta.type)}</span>
        <span class="ev-player">${sq.value}</span>
        <span class="ev-min">${sq.meta.minute?sq.meta.minute+"'":''}</span>
      </div>`
    :`<div class="sq hidden sq-event" onclick="revSq(${sq.id})">${sq.id}</div>`;
}

function renderCard(){
  const leag = G.squares.find(s=>s.type==='league');
  const seas = G.squares.find(s=>s.type==='season');
  const hteam = G.squares.find(s=>s.type==='team-home');
  const ateam = G.squares.find(s=>s.type==='team-away');
  const score = G.squares.find(s=>s.type==='score');
  const targ = G.squares.find(s=>s.type==='target');
  const ansSq = G.squares.find(s=>s.type==='answer');

  const hEv=G.squares.filter(s=>s.type==='event-home');
  const aEv=G.squares.filter(s=>s.type==='event-away');
  const hEvHtml=hEv.length?hEv.map(rEvent).join(''):`<div class="no-events">${t('noEvents')}</div>`;
  const aEvHtml=aEv.length?aEv.map(rEvent).join(''):`<div class="no-events">${t('noEvents')}</div>`;

  $('match-card').innerHTML=`
    <div class="card-meta">
      <div class="cmeta-cell"><span class="cmeta-label">${t('lblLeague')}</span>${rInfo(leag)}</div>
      <div class="cmeta-cell"><span class="cmeta-label">${t('lblSeason')}</span>${rInfo(seas)}</div>
    </div>
    <div class="card-teams">${rTeam(hteam,G.home)}${rScore(score)}${rTeam(ateam,G.away)}</div>
    <div class="card-target"><div class="ctarget-lbl">${t('lblTarget')}</div>${rTarget(targ)}</div>
    <div class="card-target" style="border-top:1px dashed var(--border2); background:rgba(200,241,53,0.01)"><div class="ctarget-lbl">${t('lblAnswer')}</div>${rAnswer(ansSq)}</div>
    <div class="card-events">
      <div class="cevents-col"><div class="cevents-head">${G.home}</div>${hEvHtml}</div>
      <div class="cevents-col"><div class="cevents-head">${G.away}</div>${aEvHtml}</div>
    </div>`;
}

function revSq(id){
  if(!G.roundActive||G.revealed.has(id))return;
  G.revealed.add(id);renderCard();
  resetTimer(); startTmr();
}
function revealAll(){
  G.squares.forEach(s=>G.revealed.add(s.id));renderCard();stopTimer();
  if(G.roundActive){G.roundActive=false; updateTurnUI(); setTimeout(()=>showOverlay(false),400);}
}

// ── TEAM TURNS ──
function updateTurnUI(){
  if(!G.roundActive) {
    $('tsb-p1').classList.remove('active-turn');
    $('tsb-p2').classList.remove('active-turn');
    return;
  }
  $('tsb-p1').classList.toggle('active-turn', G.currentTurn === 0);
  $('tsb-p2').classList.toggle('active-turn', G.currentTurn === 1);
}

function switchTurn() {
  if (!G.roundActive) return;
  if (G.eliminated[0] && G.eliminated[1]) return;
  G.currentTurn = G.currentTurn === 0 ? 1 : 0;
  if (G.eliminated[G.currentTurn]) G.currentTurn = G.currentTurn === 0 ? 1 : 0;
  updateTurnUI();
  resetTimer();
  startTmr();
}

// ── GAME HEADER ──
function renderGameHeader(){
  $('gh-p1').textContent=G.p1;$('gh-p2').textContent=G.p2;
  $('ctrl-p1-lbl').textContent=G.p1;$('ctrl-p2-lbl').textContent=G.p2;
  $('ro-p1n').textContent=G.p1;$('ro-p2n').textContent=G.p2;
  updateScore();
}
function updateScore(){
  $('gh-p1-pts').textContent=G.pts[0];$('gh-p2-pts').textContent=G.pts[1];
  $('ro-p1p').textContent=G.pts[0];$('ro-p2p').textContent=G.pts[1];
  [0,1].forEach(i=>{
    const el=$(i===0?'gh-p1-str':'gh-p2-str');el.innerHTML='';
    for(let j=0;j<2;j++){const d=document.createElement('div');d.className='sdot'+(j<G.strikes[i]?' hit':'');el.appendChild(d);}
  });
}
function updateCtrlBtns(){
  [0,1].forEach(i=>{
    const dis=G.eliminated[i]||!G.roundActive;
    $(i===0?'b-p1-ok':'b-p2-ok').disabled=dis;
    $(i===0?'b-p1-no':'b-p2-no').disabled=dis;
  });
}

// ── TIMER ──
function resetTimer(){
  stopTimer();timerSec=30;
  $('timer').textContent='30';$('timer').className='timer';
  $('lbl-tbtn').textContent=t('timerStart');
}
function toggleTimer(){timerOn?stopTimer():startTmr();}
function startTmr(){
  if(!G.roundActive)return;
  timerOn=true;$('lbl-tbtn').textContent=t('timerStop');
  $('status-bar').textContent=t('statusTiming');$('status-bar').className='status-bar on';
  timerIv=setInterval(()=>{
    timerSec--;$('timer').textContent=timerSec;
    if(timerSec<=10)$('timer').classList.add('warn');
    if(timerSec<=0){stopTimer();$('timer').textContent='0';}
  },1000);
}
function stopTimer(){
  if(timerIv){clearInterval(timerIv);timerIv=null;}
  timerOn=false;
  const b=$('lbl-tbtn');if(b)b.textContent=t('timerStart');
}

// ── ANSWERS ──
function markAnswer(ti,correct){
  if(!G.roundActive||G.eliminated[ti])return;
  stopTimer();resetTimer();
  if(correct){
    const hidden=G.squares.length-G.revealed.size;
    G.pts[ti]+=hidden;G.roundActive=false;
    updateScore();updateTurnUI();revealAll();
    setTimeout(()=>showOverlay(true,ti,hidden),500);
  } else {
    G.strikes[ti]++;
    if(G.strikes[ti]>=2)G.eliminated[ti]=true;
    updateScore();updateCtrlBtns();
    if(G.eliminated[0]&&G.eliminated[1]){
       G.roundActive=false;updateTurnUI();revealAll();
       setTimeout(()=>showOverlay(false),500);
    } else {
       switchTurn();
    }
  }
}

function showOverlay(win,ti,pts){
  $('ro-title').textContent=t('roTitle');
  $('ro-msg').innerHTML=win
    ?`<span style="color:var(--accent)">${ti===0?G.p1:G.p2}</span> — ${t('roCorrect',ti===0?G.p1:G.p2,pts).split('—')[1]||t('roCorrect',ti===0?G.p1:G.p2,pts)}`
    :t('roNobody');
  if(win) $('ro-msg').innerHTML=`<span style="color:var(--accent)">${ti===0?G.p1:G.p2}</span> ${t('roCorrect','',pts).replace('  ',' ')}`;
  $('overlay').classList.add('show');
}
function closeOverlay(){$('overlay').classList.remove('show');}

function replayCard(){
  G.strikes=[0,0];G.eliminated=[false,false];G.roundActive=true;G.revealed=new Set();G.currentTurn=0;
  renderCard();resetTimer();updateTurnUI();updateCtrlBtns();
  $('status-bar').textContent=t('statusReady');$('status-bar').className='status-bar';
}

// ── NAV ──
function goTo(v){document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));$('view-'+v).classList.add('active');}
function goSetup(){stopTimer();goTo('setup');}

// ── INIT ──
applyTX();updateTargetPreview();
</script>
</body>
</html>